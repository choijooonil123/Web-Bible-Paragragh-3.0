<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Web Bible Paragraph Sermon</title>
  <style>
    :root{
      --bg:#0f1115; --panel:#161922; --text:#e6e8ef; --muted:#9aa0ab;
      --accent:#6ea8fe; --border:#252a36; --danger:#ff6b6b; --titleBlue:#9fd0ff;
    }
    *{ box-sizing:border-box } html,body{ height:100% }
    body{
      margin:0; font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans KR",sans-serif;
      background:var(--bg); color:var(--text);
      display:grid; grid-template-rows:64px 1fr; gap:10px;
    }
    header{
      display:flex; align-items:center; gap:10px; padding:8px 10px;
      background:var(--panel); border-bottom:1px solid var(--border);
      position:sticky; top:0; z-index:5;
    }
    header h1{ font-size:16px; margin:0; font-weight:700 }
    .muted{ color:var(--muted) }
    .pill{
      display:flex; gap:8px; align-items:center; border:1px solid var(--border);
      background:color-mix(in hsl, var(--panel) 80%, black 8%); padding:6px 8px; border-radius:10px;
    }
    select, input[type="range"]{ background:transparent; color:var(--text); border:1px solid var(--border); border-radius:8px; padding:4px 6px }
    option{ color:#000 }
    button{
      background:color-mix(in hsl, var(--panel) 65%, black 10%); color:var(--text);
      border:1px solid var(--border); border-radius:10px; padding:6px 10px; cursor:pointer;
      transition:border-color .15s, transform .04s;
    }
    button:hover{ border-color:color-mix(in hsl, var(--border) 80%, var(--accent) 20%) }
    button:active{ transform:translateY(1px) }
    .primary{
      background:linear-gradient(180deg,color-mix(in srgb, var(--accent) 75%, white 10%), color-mix(in srgb, var(--accent) 75%, black 20%));
      border-color:color-mix(in srgb, var(--accent) 70%, black 10%);
    }

    .layout{ display:grid; grid-template-columns:1fr; gap:10px; padding:0 10px 12px }
    .card{ background:var(--panel); border:1px solid var(--border); border-radius:14px; overflow:hidden; display:flex; flex-direction:column; min-width:0 }
    .scroller{ overflow:auto; padding:12px }
    .footer{ padding:8px 12px; border-top:1px solid var(--border); display:flex; align-items:center; justify-content:space-between; gap:8px; flex-wrap:wrap }

    #tree{ padding:8px }
    details{
      border:1px solid var(--border); border-radius:10px; padding:6px 8px; margin-bottom:8px;
      background:color-mix(in hsl, var(--panel) 80%, black 8%);
    }
    summary{ cursor:pointer; list-style:none; display:flex; align-items:center; gap:8px }
    summary::-webkit-details-marker{ display:none }
    .tw{ font-weight:700 }
    .chapters{ display:grid; gap:6px; margin-top:6px }
    .paras{ display:grid; gap:6px; margin:8px 0 2px }
    .chip{
      font-size:.92em; padding:6px 10px; border:1px solid var(--border); border-radius:999px;
      display:inline-flex; align-items:center; gap:6px; background:color-mix(in hsl, var(--panel) 88%, black 4%); white-space:nowrap;
    }
    .chip:hover{ border-color:var(--accent) }
    .ptitle{ font-weight:800; color:var(--titleBlue) }
    .vrange{ color:var(--muted); font-weight:700 }

    .pbody{ margin-top:8px; border-top:1px dashed var(--border); padding-top:8px }
    .ptoolbar{ display:flex; gap:8px; align-items:center; flex-wrap:wrap; margin-bottom:8px }

    /* ✅ 설교 버튼이 가려지거나 사라지는 것 방지 */
    .ptoolbar .spacer { flex: 1 1 auto; }
    .ptoolbar .sermBtn { display: inline-flex; }

    .pline{ padding:4px 6px; border-left:3px solid transparent; border-radius:8px; transition: background .15s, border-color .15s }
    .pline:hover{ background:color-mix(in hsl, var(--panel) 80%, black 12%) }
    .pline.reading{ background:color-mix(in hsl, var(--accent) 15%, black 0%); border-left-color:var(--accent) }
    .pv{ color:var(--muted); font-size:.88em; vertical-align:super; margin-right:4px }

    .modal-backdrop{ position:fixed; inset:0; background:rgba(0,0,0,.45); display:none; align-items:center; justify-content:center; z-index:50 }
    .modal{ width:min(1200px, 96vw); max-height:94vh; overflow:auto; background:var(--panel); border:1px solid var(--border); border-radius:14px }
    .modal .head{
      position:sticky; top:0; background:var(--panel); padding:12px 14px;
      display:flex; gap:10px; align-items:center; border-bottom:1px solid var(--border)
    }
    .list{ padding:12px 14px; display:grid; gap:8px }
    .item{ border:1px solid var(--border); border-radius:10px; padding:6px 10px; display:flex; justify-content:space-between; align-items:center; gap:10px; flex-wrap:wrap }
    .item-title{ font-weight:700; color:var(--titleBlue); line-height:1.15; display:flex; align-items:center; gap:8px; flex-wrap:wrap }
    .item-title .date{ margin-left:8px; color:var(--muted); font-weight:400; font-size:.92em }

    .editor{ padding:14px; display:grid; gap:12px; background:var(--panel) }
    .editor input[type="text"], .editor textarea{ width:100%; background:#161922; color:#e6e8ef; border:1px solid #2a3040; border-radius:8px; padding:10px 12px }
    .editor textarea{ min-height:360px; resize:vertical }
    .editor-bar{ display:flex; gap:8px; align-items:center; flex-wrap:wrap }
    .editor-bar .grow{ flex:1 1 auto }

    /* [맥락 편집기 전용] 보기 좋은 타이포/레이아웃 */
    .context-editor {
      font-family: "Noto Serif KR", "Nanum Myeongjo", serif;
      font-size: 1.05rem;
      line-height: 1.85;
      letter-spacing: 0.02em;
      word-break: keep-all;
      background: var(--panel);
      color: var(--text);
      border-radius: 12px;
      box-shadow: 0 6px 16px rgba(0,0,0,0.25);
    }
    .context-editor input[type="text"]{
      font-family: "Noto Serif KR", "Nanum Myeongjo", serif;
      font-weight: 600;
      font-size: 1.12rem;
      letter-spacing: 0.01em;
    }
    .context-editor .rte{
      min-height:360px;resize:vertical;padding:14px;background:#161922;border:1px solid #2a3040;border-radius:10px;line-height:1.85;letter-spacing:.015em;caret-color:var(--accent);outline:none
    }
    .context-editor em,.context-editor strong,.context-editor b{
      color:#ffd66e;font-weight:600;font-style:normal
    }
    .context-editor blockquote{
      margin:12px 0;padding:10px 14px;border-left:3px solid var(--accent);
      color:#c0cad6;font-style:italic;background:rgba(255,255,255,.04);border-radius:8px
    }
    .context-editor ::selection{background:rgba(110,168,254,.25)}
    @media (max-width:640px){.context-editor{font-size:1rem}}
    @media (prefers-color-scheme:light){
      .context-editor{color:#1b2533;background:#fff;box-shadow:0 6px 16px rgba(0,0,0,.08)}
      .context-editor blockquote{color:#445066;background:#f7f9fc}
    }

    /* ==== 모달 편집기(sermonEditor) 줄 간격 타이트 모드 ==== */
    #sermonEditor.context-editor .rte{
      line-height: 1.55 !important;
      letter-spacing: 0.01em !important;
    }
    #sermonEditor.context-editor .rte p{ margin: 6px 0; }
    #sermonEditor.context-editor .rte .verse-line{ line-height: 1.5; }
    #sermonEditor.context-editor .rte .verse-line sup{ margin-right:4px; }
    #sermonEditor.context-editor .rte br{ line-height: 1.0; }

    /* ===== 모달 편집기: 본문만 스크롤 ===== */
    #sermonEditor{
      display:flex; flex-direction:column;
      height: calc(94vh - 56px); min-height: calc(94vh - 56px); max-height: calc(94vh - 56px);
      overflow: hidden;
    }
    #sermonEditor .rte {
      flex: 1 1 auto;
      min-height: 0;
      overflow-y: auto;
      padding-top: var(--editor-pad-top, 0px);
      margin-top: 0 !important;
      scroll-padding-top: var(--editor-pad-top, 0px);
    }

    /* RTE 툴바 고정 */
    #rteToolbar {
      position: sticky;
      top: 0;
      z-index: 10;
      background: var(--panel);
      border-bottom: 1px solid var(--border);
    }

    /* ===== 삽입된 성경구절 스타일 ===== */
    .inserted-verse { font-style: italic; color: #ff8080; }
    .verse-header { margin-bottom:2px; }
    .verse-line { font-style: italic; color:#ff8080; }

    /* 설교목록 링크 필드 */
    .link-box{
      display:flex; align-items:center; gap:6px; min-width:260px; flex:1 1 320px;
    }
    .link-box input{
      flex:1 1 auto; min-width:200px;
      background:#161922;color:#e6e8ef;border:1px solid #2a3040;border-radius:8px;padding:6px 8px
    }
    .link-box a{
      text-decoration:underline; color:#9fd0ff; word-break:break-all;
      max-width:280px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;
    }
    .ptoolbar .sermBtn{ margin-left:auto }
    
    /* 응급: 설교 버튼 가시성 강제 */
    .ptoolbar .sermBtn { display:inline-flex !important; visibility:visible !important; opacity:1 !important; }
    /* === 절문장 서식 툴바 === */
    #vbar{
      position: fixed; left:0; top:0;
      transform: translate(-50%, calc(-100% - 10px));
      background:#0f1320; border:1px solid var(--border);
      border-radius:10px; padding:6px;
      display:flex; gap:6px; align-items:center;
      box-shadow:0 8px 20px rgba(0,0,0,.35); z-index:9999;
    }
    #vbar[hidden]{ display:none; }
    #vbar .divider{ width:1px; height:20px; background:var(--border); }
    #vbar button{
      border:1px solid var(--border); background:#1f2533; color:var(--text);
      padding:6px 8px; border-radius:8px; cursor:pointer; font-weight:700;
    }
    #vbar button:hover{ background:#273046; }
    #vbar input[type="color"]{
      width:28px; height:28px; padding:0; border:1px solid var(--border);
      background:#1f2533; border-radius:6px; cursor:pointer;
    }
    /* === 절문장 서식 툴바 === */
    #wbp-plbar{
      position: fixed; left:0; top:0;
      transform: translate(-50%, calc(-100% - 10px));
      background:#0f1320; border:1px solid var(--border, #252a36);
      border-radius:10px; padding:6px;
      display:flex; gap:6px; align-items:center;
      box-shadow:0 8px 20px rgba(0,0,0,.35); z-index:9999;
    }
    #wbp-plbar[hidden]{ display:none; }
    #wbp-plbar .divider{ width:1px; height:20px; background:var(--border, #252a36); }
    #wbp-plbar button{
      border:1px solid var(--border, #252a36); background:#1f2533; color:#e6e8ef;
      padding:6px 8px; border-radius:8px; cursor:pointer; font-weight:700;
    }
    #wbp-plbar button:hover{ background:#273046; }
    #wbp-plbar input[type="color"]{
      width:28px; height:28px; padding:0; border:1px solid var(--border, #252a36);
      background:#1f2533; border-radius:6px; cursor:pointer;
    }
    /* 편집 모드 표시 */
    details.para .pcontent[contenteditable="true"]{
      outline: 1px dashed #3b4b7a; outline-offset: 2px;
    }

    /* ==== 컨텐츠가 채워진 버튼 시각 강조 ==== */
    .ptoolbar button.filled {
      background: color-mix(in hsl, var(--accent) 25%, var(--panel) 65%);
      border-color: var(--accent);
      box-shadow: 0 0 0 2px color-mix(in hsl, var(--accent) 35%, transparent 65%) inset;
    }
    .ptoolbar button.filled::after{
      content: "●";
      font-size: 10px;
      margin-left: 6px;
      color: var(--titleBlue);
      opacity: .9;
    }

    /* ==== 버튼별로 내용 채워짐(filled) 상태의 색상 구분 ==== */
    .ptoolbar button.filled {
      color: #fff;
      border-width: 1px;
      box-shadow: 0 0 6px rgba(0,0,0,0.25);
    }
    
    /* 내용흐름 */
    .ptoolbar .btnSummary.filled {
      background: #6a5acd;            /* 보라색 */
      border-color: #7b68ee;
    }
    
    /* 단위성경속 맥락 */
    .ptoolbar .btnUnitCtx.filled {
      background: #9370db;            /* 연보라 */
      border-color: #b48cf0;
    }
    
    /* 전체성경속 맥락 */
    .ptoolbar .btnWholeCtx.filled {
      background: #4682b4;            /* 파랑 */
      border-color: #5ca5e5;
    }
    
    /* 주석 */
    .ptoolbar .btnCommentary.filled {
      background: #3cb371;            /* 초록 */
      border-color: #58d68d;
    }
    
    /* 설교 */
    .ptoolbar .sermBtn.filled {
      background: #ff8c00;            /* 주황 */
      border-color: #ffa94d;
    }
    
    /* 시각적 강조 점 */
    .ptoolbar button.filled::after {
      content: "●";
      font-size: 10px;
      margin-left: 6px;
      opacity: .8;
      color: rgba(255,255,255,0.85);
    }

    .ptoolbar button {
      transition: background 0.25s ease, border-color 0.25s ease, color 0.25s ease;
    }
    
</style>

  <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+KR:wght@400;600&family=Nanum+Myeongjo&display=swap" rel="stylesheet">
</head>
<body>
  <header>
    <h1>Web Bible Paragraph 3.0</h1>

    <div class="pill"><button id="btnSaveJSON">JSON 저장</button></div>

    <div class="pill">
      <button id="btnExportAll">내보내기</button>
      <input id="importFile" type="file" accept="application/json" style="display:none">
      <button id="btnImportAll">가져오기</button>
    </div>

    <div class="pill">
      <span class="muted">음성</span>
      <select id="voiceSelect" title="한국어 보이스 선택">
        <option value="">브라우저 기본(ko-KR)</option>
      </select>
      <button id="testVoice">시험</button>
    </div>

    <div class="pill">
      <span class="muted">속도</span>
      <input id="rateCtl" type="range" min="0.6" max="1.4" step="0.02" value="0.95" />
      <span class="muted">톤</span>
      <input id="pitchCtl" type="range" min="0.6" max="1.4" step="0.02" value="1.00" />
    </div>

    <div class="pill" id="voiceHint" style="display:none">
      <span class="muted">한국어 보이스가 1개뿐이라 스타일 프리셋을 추가했습니다.</span>
    </div>

    <div style="flex:1"></div>
    <div class="pill"><span class="muted">단축키:</span> <span> S</span> 재생/중지 <span> · N</span> 다음 단락</div>
  </header>

  <div class="layout">
    <section class="card">
      <div class="scroller"><div id="tree"></div></div>
      <div class="footer"><div class="muted" id="status">bible-paragraph.json을 불러오는 중…</div></div>
    </section>
  </div>

  <div id="modalWrap" class="modal-backdrop" aria-hidden="true">
    <div class="modal">
      <div class="head">
        <strong id="modalTitle">단락 성경</strong>
        <span class="muted" id="modalRef">—</span>
        <div class="grow"></div>
        <button id="closeModal">닫기</button>
      </div>

      <div class="list" id="sermonList"></div>

      <!-- 단일 편집기 (중복 제거) -->
      <div class="editor context-editor" id="sermonEditor" style="display:none">
        <div id="rteToolbar" class="editor-bar">
          <button type="button" onclick="execFmt('bold')"><b>B</b></button>
          <button type="button" onclick="execFmt('italic')"><i>I</i></button>
          <button type="button" onclick="execFmt('underline')"><u>U</u></button>
          <button type="button" onclick="execFmt('strikeThrough')"><s>S</s></button>
          <div class="grow"></div>
        </div>

        <input id="sermonTitle" type="text" placeholder="제목" style="display:none" />
        <div id="sermonBody" class="rte" contenteditable="true" spellcheck="false"></div>

        <div class="editor-bar">
          <div class="grow"></div>
          <button id="editorSpeak" class="primary">낭독</button>
          <button id="saveSermon" class="primary">저장</button>
        </div>
      </div>

      <div id="modalFooterNew" class="footer" style="padding:10px 14px; border-top:1px solid var(--border)">
        <button id="newSermonBtn" class="primary">새 설교</button>
      </div>
    </div>
  </div>

  <!-- 플로팅 서식툴바: 절(.verse) 선택 시에만 표시 -->
  <div id="wbp-plbar" hidden role="toolbar" aria-label="절 서식">
    <button type="button" data-cmd="bold" title="굵게 (Ctrl+B)"><b>B</b></button>
    <button type="button" data-cmd="italic" title="기울임 (Ctrl+I)"><i>I</i></button>
    <button type="button" data-cmd="underline" title="밑줄 (Ctrl+U)"><u>U</u></button>
    <div class="divider"></div>
    <input id="wbp-plcolor" type="color" title="글자색" />
    <button type="button" data-act="clearColor" title="색 제거">⨯</button>
  </div>
  
  <script>
    /* === Paragraph .pline Floating Toolbar (Bold/Italic/Underline/Color) === */
     /* === Floating Toolbar for verse lines ( 안정판 ) === */
    (function enableVerseToolbar(){
      const bar = document.getElementById('wbp-plbar');
      const colorInp = document.getElementById('wbp-plcolor');
      if(!bar){ console.warn('[WBP] toolbar element #wbp-plbar not found'); return; }
    
      // 화면마다 구조가 조금씩 달라서 유연하게 매칭
      const LINE_SELECTOR  = '.pline, p.verse, .verse-line';         // 선택 허용 라인
      const SCOPE_SELECTOR = '.pcontent, .editor, main, body';       // contenteditable 부여 대상
    
      let savedRange = null;
    
      function findLineFromSelection(){
        const sel = window.getSelection();
        if(!sel || sel.rangeCount===0) return null;
        const n = sel.getRangeAt(0).commonAncestorContainer;
        const el = (n.nodeType===1 ? n : n.parentElement);
        return el?.closest?.(LINE_SELECTOR) || null;
      }
      function ensureEditableScope(line){
        // 라인을 감싸는 편집 가능한 컨테이너를 찾아서 없으면 부여
        const scope = line.closest(SCOPE_SELECTOR) || line.parentElement || line;
        if(scope && scope.getAttribute('contenteditable')!=='true'){
          scope.setAttribute('contenteditable','true');
        }
      }
      function hasRealSelection(){
        const sel = window.getSelection();
        return !!(sel && sel.rangeCount && !sel.getRangeAt(0).collapsed);
      }
      function saveSel(){
        const sel = window.getSelection();
        if(sel && sel.rangeCount>0) savedRange = sel.getRangeAt(0).cloneRange();
      }
      function restoreSel(){
        if(!savedRange) return false;
        const sel = window.getSelection();
        sel.removeAllRanges(); sel.addRange(savedRange);
        return true;
      }
      function getSelRect(){
        const sel = window.getSelection();
        if(!sel || sel.rangeCount===0) return null;
        const r = sel.getRangeAt(0).cloneRange();
        let rect = r.getBoundingClientRect();
        if(!rect || (rect.width===0 && rect.height===0)){
          const span = document.createElement('span');
          span.appendChild(document.createTextNode('\u200b'));
          r.insertNode(span);
          rect = span.getBoundingClientRect();
          span.remove();
        }
        return rect;
      }
      function showBarIfLine(){
        if(!hasRealSelection()){ hide(); return; }
        const line = findLineFromSelection();
        if(!line){ hide(); return; }
        ensureEditableScope(line);
    
        const rect = getSelRect();
        if(!rect){ hide(); return; }
    
        // fixed 기준: viewport 좌표 그대로 사용
        bar.style.left = (rect.left + rect.width/2) + 'px';
        bar.style.top  = rect.top + 'px';
        bar.hidden = false;
        saveSel();
      }
      function hide(){ bar.hidden = true; }
    
      // 툴바 조작
      bar.addEventListener('mousedown', e=> e.preventDefault());
      bar.addEventListener('click', e=>{
        const btn = e.target.closest('button'); if(!btn) return;
        if(!restoreSel()) return;
    
        const cmd = btn.dataset.cmd;
        const act = btn.dataset.act;
    
        if(cmd){
          document.execCommand(cmd,false,null);   // bold / italic / underline
          saveSel(); showBarIfLine();
          return;
        }
        if(act==='clearColor'){
          try{
            const sel = window.getSelection(); if(!sel || sel.rangeCount===0) return;
            const range = sel.getRangeAt(0);
            const frag  = range.cloneContents();
            const div   = document.createElement('div'); div.appendChild(frag);
            div.querySelectorAll('span, font').forEach(n=>{
              if(n.style?.color) n.style.color = '';
              if(n.hasAttribute?.('color')) n.removeAttribute('color');
              if(n.getAttribute?.('style')==='') n.removeAttribute('style');
            });
            range.deleteContents();
            document.execCommand('insertHTML', false, div.innerHTML || div.textContent || '');
          }catch(_){}
          saveSel(); showBarIfLine();
        }
      });
    
      colorInp?.addEventListener('input', ()=>{
        if(!restoreSel()) return;
        document.execCommand('foreColor', false, colorInp.value);
        saveSel(); showBarIfLine();
      });
    
      // 선택 변화에 반응 — 드래그/키입력/마우스업 모두 커버
      document.addEventListener('selectionchange', ()=> setTimeout(showBarIfLine, 0));
      document.addEventListener('mouseup',         ()=> setTimeout(showBarIfLine, 0));
      document.addEventListener('keyup',           ()=> setTimeout(showBarIfLine, 0));
      window.addEventListener('scroll', hide, {passive:true});
      window.addEventListener('resize', hide);
    
      // 단축키(Ctrl/Cmd + B/I/U) — 라인 내부에서만 작동
      window.addEventListener('keydown', (e)=>{
        if(!(e.ctrlKey||e.metaKey)) return;
        const k = e.key.toLowerCase();
        if(!['b','i','u'].includes(k)) return;
        if(!findLineFromSelection()) return;
        if(!hasRealSelection()) return;
        e.preventDefault();
        document.execCommand(k==='b'?'bold':k==='i'?'italic':'underline', false, null);
        setTimeout(showBarIfLine, 0);
      });
    
      // 디버그 강제 표시(옵션): Alt+K -> 현재 선택에서 강제 표시
      window.addEventListener('keydown', (e)=>{
        if(e.altKey && e.key.toLowerCase()==='k'){
          setTimeout(showBarIfLine, 0);
        }
      });
    })();

  </script>

  <script src="app.js" defer></script>

  <script>
    /* ========= [WBP v3 Filled-State Patch] =========
       - 각 단락 툴바의 버튼(내용흐름/단위/전체/주석/설교)에
         해당 데이터가 존재하면 .filled 클래스를 추가해 색상 변경
       - 기존 코드 삭제/수정 없이 하단에 붙여 쓰는 안정형 패치
    ================================================= */
    
    /** 안전 접근 유틸 */
    function WBP_safe(fn, fallback){ try{ return fn(); }catch(_){ return fallback; } }
    
    /** paraId 계산: `${book}|${chap}|${ref}` */
    function WBP_paraId(book, chap, paraIdx){
      const para = WBP_safe(()=>BIBLE.books[book][chap].paras[paraIdx], null);
      if(!para) return null;
      return `${book}|${chap}|${para.ref}`;
    }
    
    /** 단락 엘리먼트에서 book/chap/idx 파싱 */
    function WBP_pickMetaFromParaEl(paraEl){
      const t = paraEl.querySelector('summary .ptitle');
      if(!t) return null;
      const book = t.dataset.book;
      const chap = parseInt(t.dataset.ch, 10);
      const idx  = parseInt(t.dataset.idx, 10);
      if(!book || !Number.isFinite(chap) || !Number.isFinite(idx)) return null;
      return {book, chap, idx};
    }
    
    /** 저장된 문서/설교 유무 확인 */
    function WBP_hasDoc(map, pid){
      const doc = (map||{})[pid];
      if(!doc) return false;
      const body = (doc.body || '').replace(/\s+/g,'').trim();
      const title= (doc.title||'').replace(/\s+/g,'').trim();
      return !!(body || title);
    }
    function WBP_hasSermon(sermonMap, pid){
      const arr = (sermonMap||{})[pid] || [];
      return Array.isArray(arr) && arr.length > 0 && arr.some(it=>{
        const title=(it.title||'').replace(/\s+/g,'').trim();
        const body =(it.body ||'').replace(/\s+/g,'').trim();
        return !!(title || body);
      });
    }
    
    /** 단락 하나에 대해 버튼 상태 적용 */
    function WBP_applyFilledToParaEl(paraEl){
      const meta = WBP_pickMetaFromParaEl(paraEl);
      if(!meta) return;
    
      const pid = WBP_paraId(meta.book, meta.chap, meta.idx);
      if(!pid) return;
    
      // 저장 맵 읽기
      const sermonMap = WBP_safe(()=>JSON.parse(localStorage.getItem(STORAGE_SERMON)||'{}'), {});
      const unitMap   = WBP_safe(()=>JSON.parse(localStorage.getItem(STORAGE_UNIT_CTX)||'{}'), {});
      const wholeMap  = WBP_safe(()=>JSON.parse(localStorage.getItem(STORAGE_WHOLE_CTX)||'{}'), {});
      const commMap   = WBP_safe(()=>JSON.parse(localStorage.getItem(STORAGE_COMMENTARY)||'{}'), {});
      const sumMap    = WBP_safe(()=>JSON.parse(localStorage.getItem(STORAGE_SUMMARY)||'{}'), {});
    
      // 상태
      const hasSummary    = WBP_hasDoc(sumMap,  pid);
      const hasUnit       = WBP_hasDoc(unitMap, pid);
      const hasWhole      = WBP_hasDoc(wholeMap,pid);
      const hasCommentary = WBP_hasDoc(commMap, pid);
      const hasSermon     = WBP_hasSermon(sermonMap, pid);
    
      // 버튼에 .filled 토글
      const tb = paraEl.querySelector('.ptoolbar');
      if(!tb) return;
    
      const btnSummary    = tb.querySelector('.btnSummary');
      const btnUnitCtx    = tb.querySelector('.btnUnitCtx');
      const btnWholeCtx   = tb.querySelector('.btnWholeCtx');
      const btnCommentary = tb.querySelector('.btnCommentary');
      const btnSermon     = tb.querySelector('.sermBtn');
    
      if(btnSummary)    btnSummary.classList.toggle('filled',    !!hasSummary);
      if(btnUnitCtx)    btnUnitCtx.classList.toggle('filled',    !!hasUnit);
      if(btnWholeCtx)   btnWholeCtx.classList.toggle('filled',   !!hasWhole);
      if(btnCommentary) btnCommentary.classList.toggle('filled', !!hasCommentary);
      if(btnSermon)     btnSermon.classList.toggle('filled',     !!hasSermon);
    }
    
    /** 화면 전체 스윕 */
    function WBP_sweepAll(){
      document.querySelectorAll('#tree details.para').forEach(WBP_applyFilledToParaEl);
    }
    
    /** buildTree 이후/토글 시 반영: MutationObserver */
    (function(){
      const root = document.getElementById('tree');
      if(!root) return;
      // 최초 한 번
      setTimeout(WBP_sweepAll, 200);
    
      // 구조 변동 시 자동 반영
      const mo = new MutationObserver(()=> WBP_sweepAll());
      mo.observe(root, {subtree:true, childList:true});
    })();
    
    /** 저장 함수 래핑: setSermonMap / setDocMap 호출 후 상태 갱신 */
    (function wrapSavers(){
      const _setSermonMap = window.setSermonMap;
      const _setDocMap    = window.setDocMap;
    
      if(typeof _setSermonMap === 'function'){
        window.setSermonMap = function(o){
          const r = _setSermonMap.call(this, o);
          // 현재 열린 단락 우선 갱신
          const openPara = document.querySelector('#tree details.para[open]') || null;
          if(openPara) WBP_applyFilledToParaEl(openPara);
          // 전체도 안전하게 갱신
          setTimeout(WBP_sweepAll, 0);
          return r;
        }
      }
      if(typeof _setDocMap === 'function'){
        window.setDocMap = function(key, obj){
          const r = _setDocMap.call(this, key, obj);
          const openPara = document.querySelector('#tree details.para[open]') || null;
          if(openPara) WBP_applyFilledToParaEl(openPara);
          setTimeout(WBP_sweepAll, 0);
          return r;
        }
      }
    })();
    
    /** 단락 열릴 때도 즉시 반영 (토글 이벤트 위임) */
    document.getElementById('tree')?.addEventListener('toggle', (e)=>{
      const para = e.target?.closest?.('details.para');
      if(para && para.open){ WBP_applyFilledToParaEl(para); }
    }, true);
    
    /** 수동 새로고침 핫키(옵션): Alt+L */
    window.addEventListener('keydown', (e)=>{
      if(e.altKey && e.key.toLowerCase()==='l'){ WBP_sweepAll(); }
    });
    </script>

</body>
</html>
